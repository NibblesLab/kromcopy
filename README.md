# kromcopy
MZ-1500用オプション・MZ-1R23(漢字ROM)とMZ-1R24(辞書ROM)の内容をBeMicro MAX10ボード搭載のシリアルフラッシュROMであるM25P16に書き込むための回路とプログラムです。
「MZ-1500バージョンアップアダプタ」ボードで使用することを前提としています。
## 手順
「MZ-1500バージョンアップアダプタ」が回路の都合上他のデバイスによるウェイト発生を考慮していないため、書き込み作業はMZ-700で行いました。
全体としての手順は次の通りとなります。

1. 漢字ROMと辞書ROMのデータを作成する
2. ボードをMZ-700に接続しFPGA回路をコンフィグする
3. 書き込みプログラムとデータをロードし、フラッシュROMに書き込む

## 漢字ROM/辞書ROMデータの作成
実機から吸い出す方法と、Windowsから作成する方法のふたつがあります。
いずれも紅茶羊羹氏の「[We Love MZ-700](http://www.maroon.dti.ne.jp/youkan/mz700/)」掲載のツールを使用します。
### 実機から吸い出し
漢字ROMに含まれる機種固有文字や辞書ROMを使用するためには実機からデータを取り出す(吸い出す)必要があります。
吸い出しにはMZ-1500とMZ-1R23・MZ-1R24、およびデータレコーダ(テープレコーダ)が必要です。
データレコーダはオプションのMZ-1T03があるとベストですが簡単には手に入りませんよね…。
ボイスレコーダみたいなものでも行けそうな気がしますが、試したことはありません。
テープレコーダ等で作成する場合、20分テープを最大6本用意してください。データひとつにつき8分強あります。

紅茶羊羹氏のサイトから[kanjirom.mzt](http://www.maroon.dti.ne.jp/youkan/mz700/kanjirom.zip)をダウンロードして、mztファイルをMZ-1500にロードします。
mztファイルはまるくんのサイト「[MZ-700 Emulator MZ700WIN For Windows](http://retropc.net/mz-memories/mz700/)」からのりのり氏作[mzt2wav](http://retropc.net/mz-memories/mz700/arc/mzt2wav.lzh)をダウンロードし、wavファイルに変換後テープに録音したものをMZにセットしてロードします。
テープを使わなくてもカーステレオ用カセットアダプタなんかを使う方法もあります。

実行するとROMデータが32KB単位でテープにSAVEされます。漢字ROMだけなら最初の4つ、辞書ROMも合わせると計12個のデータができあがります。
### Windowsから作成
漢字ROMボードを所有していない場合、Windowsからフォントを生成することも可能です。
この場合現代のPCに含まれない記号や文字が表示できなくなったり、辞書ROMのデータは作成できないという問題があるのですが、JIS第一水準から欠けている文字はありませんし、辞書ROMを使えるソフトはユーカラJJしかないということもありますので、実用的にはほとんど問題になることはない…と割り切ることもできます。

ツールはやはり紅茶羊羹氏作[mk1r23](http://www.maroon.dti.ne.jp/youkan/mz700/mk1r23.zip)をダウンロードして使用します。
これはエミュレータ用のデータを作成するツールなので、128KBのバイナリデータが出力されます。
これを32KB単位で分割して、それぞれのデータの頭にmztファイルのヘッダを付けてmztファイルとして保存します。
ファイルの分割は適当なバイナリエディタを使用して下さい。
ヘッダの詳細はまるくんのサイトの[FAQ](http://retropc.net/mz-memories/mz700/mz700faq.html#q03-01)を参考にしてください。
ロードアドレスは2000h番地、実行アドレスは00ADh番地としてください。

これをmzt2wavでwavファイルに変換し、テープまたはカセットアダプタなどでMZにロードすることになります。
## FPGAのコンフィグ
MAX10をサポートするQuartus PrimeおよびProgrammerを[アルテラ](https://www.altera.co.jp/)のサイトからダウンロードしておいてください。
PrimeになってからはProgrammer単体でのダウンロードはできなくなったのかな?
いずれにしても、プロジェクトを開く必要はなく、output_filesフォルダにあるsofファイルをFPGAにダウンロードするだけでOKです。
今だけ使う回路なのでpofファイルをFPGAに書き込むことはありません。
ダウンロードが終わったらMZ-700をリセットするなりしてモニタ(1Z-009A)が動作している状態にして下さい。
## データの書き込み
とりあえずkromcopy.mzt(kromcopy.wav)をMZ-700にロードしてください。softwareフォルダに入れてあります。
メッセージが出ますが、SHIFT+BREAKを押すとアボート終了します。
このプログラムは1800h番地からロードされ、先頭番地にジャンプ(Jコマンド)すると書き込みルーチンが走るのですが、1803h番地にジャンプするとバルクイレースコマンドを実行してシリアルフラッシュROMの全体を消去するようにしてあります。
書き込んだ結果をご破算にするとか、以前何を書いたか分からないとかの場合はまずこれを実行してチップ全体を消去して下さい。

次に書き込みたいデータをロードします。テープに入れてあるはずですから、書き込むデータのあるテープをセットしてLコマンドを実行して下さい。
ロード修了後(もちろん前でもいいのですが)、ロードしたデータが何番目の物なのかを示す数値を1802h番地にMコマンドで書き込んでください。
何がどれになるのかというと…

* 漢字ROM … 00～03
* 辞書ROM … 08～0F

です。それぞれ通し番号がついているはずですので、それと書き込む数値の順番を合わせて1802h番地に書き込んで下さい。
この値が書き込むアドレスに変換されるようになっています。

データがロードできて、それに該当する番号を設定できたら、1800h番地にジャンプして書き込みを実行して下さい。
書き込みアドレスが表示されますので、以前書き込んだアドレスではないことを確認して、どれかのキーを押せば書き込みがスタートします。
32KBしかないのですぐ終わります。これをデータの数だけ繰り返して下さい。

## 回路について
## 謝辞
この回路およびプログラムは以下の方々の成果物・解析結果をもとに作成いたしました。この場を借りて御礼を申し上げます。

* 漢字ROM・辞書ROM関連 … 紅茶羊羹さま
* テープデータ関連 … のりのりさま
* その他もろもろ … まるくんさま
